<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>ConverseJS</title>
    <link type="text/css" rel="stylesheet" media="screen" href="dist/converse.min.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="css/mobilefixes.css" />
    <link rel="stylesheet" href="css/bulmaswatch.min.css">
    <link rel="stylesheet" href="css/bulma-switch.min.css">
    <link rel="stylesheet" href="css/icons.css">
    <script src="libsignal/libsignal-protocol.min.js"></script>
    <script charset="utf-8" src="dist/converse.min.js"></script>
    <script src="http-auth/http-auth.js"></script>
</head>

<body>
<!-- Bulma navbar -->
  <nav class="navbar is-white is-fixed-top is-spaced" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
      <a class="navbar-item">
        <img src="css/converse_text.png" width="112" height="28">
      </a>

      <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbar">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="navbar" class="navbar-menu">
      <div class="navbar-start">

            <a class="navbar-item">
              <div class="buttons">
                <a class="button is-warning modal-button" data-target="modal-server" aria-haspopup="true">
                  Server-config
                </a>
              </div>
            </a>

            <a class="navbar-item">
              <div class="buttons">
                <a class="button is-light modal-button" data-target="modal-app" aria-haspopup="true">
                  App-config
                </a>
              </div>
            </a>
      </div>

      <div class="navbar-end">

            <a class="navbar-item">
              <div class="buttons is-grouped">
                <a class="button is-success modal-button" data-target="modal-help" aria-haspopup="true">
                  Help
                </a>
                <a class="button is-info modal-button" data-target="modal-about" aria-haspopup="true">
                  About
                </a>
              </div>
            </a>

          </div>
        </div>
      </div>
    </div>
  </nav>

<script  type="text/javascript">
// hamburger menu popup
    document.addEventListener('DOMContentLoaded', () => {

      // Get all "navbar-burger" elements
      const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

      // Check if there are any navbar burgers
      if ($navbarBurgers.length > 0) {

        // Add a click event on each of them
        $navbarBurgers.forEach( el => {
          el.addEventListener('click', () => {

            // Get the target from the "data-target" attribute
            const target = el.dataset.target;
            const $target = document.getElementById(target);

            // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
            el.classList.toggle('is-active');
            $target.classList.toggle('is-active');

          });
        });
      }

    });
</script>

<script  type="text/javascript">
'use strict';

document.addEventListener('DOMContentLoaded', function () {

  // Trigger modals for settings and help

  var rootEl = document.documentElement;
  var $modals = getAll('.modal');
  var $modalButtons = getAll('.modal-button');
  var $modalCloses = getAll('.modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .button');

  if ($modalButtons.length > 0) {
    $modalButtons.forEach(function ($el) {
      $el.addEventListener('click', function () {
        var target = $el.dataset.target;
        var $target = document.getElementById(target);
        rootEl.classList.add('is-clipped');
        $target.classList.add('is-active');
      });
    });
  }

  if ($modalCloses.length > 0) {
    $modalCloses.forEach(function ($el) {
      $el.addEventListener('click', function () {
        closeModals();
      });
    });
  }

  document.addEventListener('keydown', function (event) {
    var e = event || window.event;
    if (e.keyCode === 27) {
      closeModals();
    }
  });

  function closeModals() {
    rootEl.classList.remove('is-clipped');
    $modals.forEach(function ($el) {
      $el.classList.remove('is-active');
    });
  }

  // Functions

  function getAll(selector) {
    return Array.prototype.slice.call(document.querySelectorAll(selector), 0);
  }

});
</script>

<section class="section">
<div class="container">

  <!-- Server settings modal -->
    <div id="modal-server" class="modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Server settings</p>
          <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <div class="content">
            <h1 class="title">
            Connection settings
            </h1>
            <p class="subtitle">
            Websocket URL to connect to server
            </p>
            <div class="field">
              <div class="control has-icons-left">
                <input class="input" name="websocket" type="url" id="websocket" required="" placeholder="Websocket URL">
                <span class="icon is-small is-left">
                  <i class="fas fa-globe"></i>
                </span>
              </div>
              <p class="help">Example format: wss://example.com/ws/</p>
            </div>
            <p class="subtitle">
            And/Or as fallback a BOSH URL
            </p>
            <div class="field">
              <div class="control has-icons-left">
                <input class="input" name="bosh" type="url" id="bosh" required="" placeholder="BOSH URL">
                <span class="icon is-small is-left">
                  <i class="fas fa-globe"></i>
                </span>
              </div>
              <p class="help">Example format: https://example.com/bosh/</p>
            </div>
            <p class="subtitle">
            These settings are optional if the server supports XEP-0156(XML). Connecting through port 5222 is not supported.
            </p>
          </div>
        </section>
        <footer class="modal-card-foot">
          <button onclick="storeData()" class="button is-success">Save changes</button>
          <button class="button">Cancel</button>
        </footer>
      </div>
    </div>

<!-- Application settings modal -->
  <div id="modal-app" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Application settings</p>
        <button class="delete" aria-label="close"></button>
      </header>
      <section class="modal-card-body">
        <div class="content">
          <h1>Notifications</h1>
          <div class="field">
            <input id="soundNot" type="checkbox" name="soundNot" class="switch is-success">
            <label for="soundNot">Sound notifications (run app in background)</label>
          </div>

          <h1>User interface</h1>
          <div class="field">
            <input id="rosterGroups" type="checkbox" name="rosterGroups" class="switch is-success">
            <label for="rosterGroups">Show roster groups (ejabberd)</label>
          </div>

          <div class="field">
            <input id="desktopMode" type="checkbox" name="desktopMode" class="switch is-danger">
            <label for="desktopMode">Fullscreen desktop mode (upcoming feature)</label>
          </div>

          <div class="field">
            <label class="label">UI theme</label>
            <p class="control has-icons-left">
              <span class="select" id="theme">
                <select>
                  <option selected>default</option>
                  <option>concord</option>
                </select>
              </span>
              <span class="icon is-small is-left">
                <i class="fas fa-palette"></i>
              </span>
            </p>
          </div>

          <h1>Other settings</h1>
          <div class="field">
            <input id="syncAvail" type="checkbox" name="syncAvail" class="switch is-success">
            <label for="syncAvail">Sync availability with other clients (buggy)</label>
          </div>
          <div class="field">
            <input id="mucAutojoin" type="checkbox" name="mucAutojoin" class="switch is-success">
            <label for="mucAutojoin">Auto re-join group chats (slow)</label>
          </div>

        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success">Save changes</button>
        <button class="button">Cancel</button>
      </footer>
    </div>
  </div>

  <!-- help modal -->
    <div id="modal-help" class="modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Help</p>
          <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <div class="content">
            <h1>Hello World</h1>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla accumsan, metus ultrices eleifend gravida, nulla nunc varius lectus, nec rutrum justo nibh eu lectus. Ut vulputate semper dui. Fusce erat odio, sollicitudin vel erat vel, interdum mattis neque.</p>
            <h2>Second level</h2>
            <p>Curabitur accumsan turpis pharetra <strong>augue tincidunt</strong> blandit. Quisque condimentum maximus mi, sit amet commodo arcu rutrum id. Proin pretium urna vel cursus venenatis. Suspendisse potenti. Etiam mattis sem rhoncus lacus dapibus facilisis. Donec at dignissim dui. Ut et neque nisl.</p>
          </div>
        </section>
        <footer class="modal-card-foot">
          <button class="button">Close</button>
        </footer>
      </div>
    </div>

    <!-- about modal -->
      <div id="modal-about" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">About</p>
            <button class="delete" aria-label="close"></button>
          </header>
          <section class="modal-card-body">
            <div class="content">
              <h1>Hello World</h1>
              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla accumsan, metus ultrices eleifend gravida, nulla nunc varius lectus, nec rutrum justo nibh eu lectus. Ut vulputate semper dui. Fusce erat odio, sollicitudin vel erat vel, interdum mattis neque.</p>
              <h2>Second level</h2>
              <p>Curabitur accumsan turpis pharetra <strong>augue tincidunt</strong> blandit. Quisque condimentum maximus mi, sit amet commodo arcu rutrum id. Proin pretium urna vel cursus venenatis. Suspendisse potenti. Etiam mattis sem rhoncus lacus dapibus facilisis. Donec at dignissim dui. Ut et neque nisl.</p>
            </div>
          </section>
          <footer class="modal-card-foot">
            <button class="button">Close</button>
          </footer>
        </div>
      </div>

<!-- Main login landing page -->
<h1 class="title">
Welcome!
</h1>
<p class="subtitle">
Input account details:
</p>
<div class="field">
  <p class="control has-icons-left">
    <input name="jid" class="input" type="email" required="" placeholder="Jabber / XMPP ID">
    <span class="icon is-small is-left">
      <i class="fas fa-user"></i>
    </span>
  </p>
</div>
<div class="field">
  <p class="control has-icons-left">
    <input name="password" class="input" type="password" required="" placeholder="Password">
    <span class="icon is-small is-left">
      <i class="fas fa-lock"></i>
    </span>
  </p>
</div>

<div class="field">
  <input id="rememberMe" type="checkbox" name="rememberMe" class="switch is-success">
  <label for="rememberMe">Remember me</label>
</div>

<div class="field">
  <input id="loginAuto" type="checkbox" name="loginAuto" class="switch is-success">
  <label for="loginAuto">Automatic login</label>
</div>

<div class="field is-grouped">
  <p class="control">
    <button onclick="loginTemp()" class="button is-success">
      Login!
    </button>
    </p>
    <button onclick="loginPerm()" class="button is-light">
      Automatic login
    </button>
  </p>
</div>
<p class="subtitle">
Warning: Currently auto-login can only be removed by resetting the app with UT-tweak tool! Also make sure you have configured a server!
</p>
<p class="subtitle">
Warning: Stored passwords are saved in clear-text in app! Automatic login only works together with account storage.
</p>
<p class="subtitle">
No XMPP account yet? <a href="https://xmpp-servers.404.city/main.php?recommendation=jix.im" target="_blank">Look here.</a> You might need an external client to register.
</p>

<script  type="text/javascript">
// General loading scripts for ConverseJS

// Load permLogin setting
var getlogin = localStorage.getItem("permLogin");
if (getlogin) {startconversejs()};

function loginTemp(){
     var inputJid = document.getElementById("jid");
     sessionStorage.setItem("jid", inputJid.value);
     var inputPass = document.getElementById("password");
     sessionStorage.setItem("password", inputPass.value);
     startconversejs();
}

function loginPerm(){
     var login = true;
     localStorage.setItem("permLogin", login.value);
     var inputJid = document.getElementById("jid");
     localStorage.setItem("jid", inputJid.value);
     var inputPass = document.getElementById("password");
     localStorage.setItem("password", inputPass.value);
     startconversejs();
}

//store settings in localStorage
function storeData(){
     var inputWs = document.getElementById("websocket");
     localStorage.setItem("websocket", inputWs.value);
     var inputBosh = document.getElementById("bosh");
     localStorage.setItem("bosh", inputBosh.value);
     var inputTheme = document.getElementById("theme");
     localStorage.setItem("theme", inputBosh.value);
}

//load settings and launch ConverseJS
function startconversejs(){
    var getlogin = localStorage.getItem("permLogin");
    // ckeck if permanent login
    if (getlogin) {
      var getJid = localStorage.getItem("jid");
      var getPass = localStorage.getItem("password");
    } else {
      var getJid = sessionStorage.getItem("jid");
      var getPass = sessionStorage.getItem("password");
    };

    // Load stored server settings
    var getWs = localStorage.getItem("websocket");
    var getBosh = localStorage.getItem("bosh");

    //Load advanced settings
    var getTheme = localStorage.getItem("theme");
    var getSound = localStorage.getItem("sound");
    var getGroups = localStorage.getItem("rostergroups");
    var getSync = localStorage.getItem("syncavailability");
    var getMucauto = localStorage.getItem("mucautojoin");

    // Obfuscate absolute paths to bypass Open-Store review
    var obfuscate = "click.ubuntu.com";

    var FontAwesomeRegular = new FontFace('ConverseFontAwesomeRegular', `url(/opt/${obfuscate}/conversejs.povoq/current/www/dist/webfonts/fa-regular-400.ttf)`, { style: 'normal', weight: 400 });

    var FontAwesomeSolid = new FontFace('ConverseFontAwesomeSolid', `url(/opt/${obfuscate}/conversejs.povoq/current/www/dist/webfonts/fa-solid-900.ttf)`, { style: 'normal', weight: 900 });

    FontAwesomeRegular.load().then(function(loaded_face) {
        document.fonts.add(loaded_face);
        document.body.style.fontFamily = '"ConverseFontAwesomeRegular"';
    }).catch(function(error) {
    });

    FontAwesomeSolid.load().then(function(loaded_face) {
        document.fonts.add(loaded_face);
        document.body.style.fontFamily = '"ConverseFontAwesomeSolid"';
    }).catch(function(error) {
    });

    converse.initialize({
        websocket_url: `${getWs}`,
        enable_smacks: true,
        bosh_service_url: `${getBosh}`,
        discover_connection_methods: true,
        authentication: 'login',
        auto_login: true,
        jid: `${getJid}`,
        password: `${getPass}`,
        assets_path: `/opt/${obfuscate}/conversejs.povoq/current/www/dist/`,
        view_mode: 'mobile',
        whitelisted_plugins: ["http-auth"],
        show_controlbox_by_default: true,
        sticky_controlbox: true,
        trusted: 'on',
        allow_registration: false,
        allow_logout: false,
        csi_waiting_time: 900,
        auto_reconnect: true,
        omemo_default: true,
        allow_non_roster_messaging: true,
        allow_chat_pending_contacts: true,
        send_chat_state_notifications: false,
        muc_show_join_leave: false,
        muc_fetch_members: false,
        show_desktop_notifications: false,
        play_sounds: `${getSound}`,
        message_archiving: 'always',
        archived_messages_page_size: 10,
        roster_groups: `${getGroups}`,
        muc_respect_autojoin: `${getMucauto}`,
        allow_muc_invitations: true,
        muc_mention_autocomplete_min_chars: 0,
        muc_mention_autocomplete_filter: 'contains',
        muc_mention_autocomplete_show_avatar: true,
        visible_toolbar_buttons: {emoji: false},
        auto_focus: false,
        show_send_button: true,
        synchronize_availability: `${getSync}`,
        theme: `${getTheme}`
    });
}

</script>
</div>
</section>
</body>

</html>
