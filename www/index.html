<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>ConverseJS</title>
    <link type="text/css" rel="stylesheet" media="screen" href="dist/converse.min.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="css/mobilefixes.css" />
    <link rel="stylesheet" href="css/bulmaswatch.min.css">
    <link rel="stylesheet" href="css/bulma-switch.min.css">
    <link rel="stylesheet" href="css/icons.css">
    <script src="libsignal/libsignal-protocol.min.js"></script>
    <script charset="utf-8" src="dist/converse.min.js"></script>
    <script src="http-auth/http-auth.js"></script>
</head>

<body>
<!-- Bulma navbar -->
  <nav class="navbar is-white is-fixed-top is-spaced" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
      <a class="navbar-item">
        <img src="css/converse_text.png" width="112" height="28">
      </a>

      <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbar">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="navbar" class="navbar-menu">
      <div class="navbar-start">

            <a class="navbar-item">
              <div class="buttons">
                <a class="button is-warning modal-button has-icons-left" data-target="modal-server" aria-haspopup="true">
                  <span class="icon is-small is-left">
                    <i class="fas fa-hdd"></i>
                  </span>
                  <p>Server-config</p>
                </a>
              </div>
            </a>

            <a class="navbar-item">
              <div class="buttons">
                <a class="button is-light modal-button has-icons-left" data-target="modal-app" aria-haspopup="true">
                  <span class="icon is-small is-left">
                    <i class="fas fa-edit"></i>
                  </span>
                  <p>App-config</p>
                </a>
              </div>
            </a>
      </div>

      <div class="navbar-end">

            <a class="navbar-item">
              <div class="buttons is-grouped">
                <a class="button is-success modal-button has-icons-left" data-target="modal-help" aria-haspopup="true">
                  <span class="icon is-small is-left">
                    <i class="fas fa-life-ring"></i>
                  </span>
                  <p>Help</p>
                </a>
                <a class="button is-info modal-button has-icons-left" data-target="modal-about" aria-haspopup="true">
                  <span class="icon is-small is-left">
                    <i class="fas fa-question-circle"></i>
                  </span>
                  <p>About</p>
                </a>
              </div>
            </a>

          </div>
        </div>
      </div>
    </div>
  </nav>

<script  type="text/javascript">
// hamburger menu popup
    document.addEventListener('DOMContentLoaded', () => {

      // Get all "navbar-burger" elements
      const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

      // Check if there are any navbar burgers
      if ($navbarBurgers.length > 0) {

        // Add a click event on each of them
        $navbarBurgers.forEach( el => {
          el.addEventListener('click', () => {

            // Get the target from the "data-target" attribute
            const target = el.dataset.target;
            const $target = document.getElementById(target);

            // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
            el.classList.toggle('is-active');
            $target.classList.toggle('is-active');

          });
        });
      }

    });
</script>

<script  type="text/javascript">
'use strict';

document.addEventListener('DOMContentLoaded', function () {

  // Trigger modals for settings and help

  var rootEl = document.documentElement;
  var $modals = getAll('.modal');
  var $modalButtons = getAll('.modal-button');
  var $modalCloses = getAll('.modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .button');

  if ($modalButtons.length > 0) {
    $modalButtons.forEach(function ($el) {
      $el.addEventListener('click', function () {
        var target = $el.dataset.target;
        var $target = document.getElementById(target);
        rootEl.classList.add('is-clipped');
        $target.classList.add('is-active');
      });
    });
  }

  if ($modalCloses.length > 0) {
    $modalCloses.forEach(function ($el) {
      $el.addEventListener('click', function () {
        closeModals();
      });
    });
  }

  document.addEventListener('keydown', function (event) {
    var e = event || window.event;
    if (e.keyCode === 27) {
      closeModals();
    }
  });

  function closeModals() {
    rootEl.classList.remove('is-clipped');
    $modals.forEach(function ($el) {
      $el.classList.remove('is-active');
    });
  }

  // Functions

  function getAll(selector) {
    return Array.prototype.slice.call(document.querySelectorAll(selector), 0);
  }

});
</script>

<section class="section">
<div class="container">

  <!-- Server settings modal -->
    <div id="modal-server" class="modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Server settings</p>
          <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <div class="content">
            <h1 class="title">
            Connection settings
            </h1>
            <p class="subtitle">
            Websocket URL to connect to server
            </p>
            <div class="field">
              <div class="control has-icons-left">
                <input class="input" name="websocket" type="url" id="websocket" required="" placeholder="Websocket URL">
                <span class="icon is-small is-left">
                  <i class="fas fa-globe"></i>
                </span>
              </div>
              <p class="help">Example format: wss://example.com/ws/</p>
            </div>
            <p class="subtitle">
            And/Or as fallback a BOSH URL
            </p>
            <div class="field">
              <div class="control has-icons-left">
                <input class="input" name="bosh" type="url" id="bosh" required="" placeholder="BOSH URL">
                <span class="icon is-small is-left">
                  <i class="fas fa-globe"></i>
                </span>
              </div>
              <p class="help">Example format: https://example.com/bosh/</p>
            </div>
            <p class="subtitle">
            These settings are optional if the server supports XEP-0156(XML). Connecting through port 5222 is not supported.
            </p>
          </div>
        </section>
        <footer class="modal-card-foot">
          <button onclick="storeData()" class="button is-success">Save changes</button>
          <button class="button">Cancel</button>
        </footer>
      </div>
    </div>

<!-- Application settings modal -->
  <div id="modal-app" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Application settings</p>
        <button class="delete" aria-label="close"></button>
      </header>
      <section class="modal-card-body">
        <div class="content">
          <h1>Notifications</h1>
          <div class="field">
            <input id="sound" type="checkbox" name="sound" class="switch is-success">
            <label for="sound">Sound notifications (run app in background)</label>
          </div>

          <h1>User interface</h1>
          <div class="field">
            <input id="rostergroups" type="checkbox" name="rostergroups" class="switch is-success">
            <label for="rostergroups">Show roster groups (ejabberd)</label>
          </div>

          <div class="field">
            <input id="desktopmode" type="checkbox" name="desktopmode" class="switch is-danger">
            <label for="desktopmode">Fullscreen desktop mode (upcoming feature)</label>
          </div>

          <div class="field">
            <label class="label">UI theme</label>
            <p class="control has-icons-left">
              <span class="select" id="theme">
                <select>
                  <option selected>default</option>
                  <option>concord</option>
                </select>
              </span>
              <span class="icon is-small is-left">
                <i class="fas fa-palette"></i>
              </span>
            </p>
          </div>

          <h1>Other settings</h1>
          <div class="field">
            <input id="syncavailability" type="checkbox" name="syncavailability" class="switch is-success">
            <label for="syncavailability">Sync availability with other clients (buggy)</label>
          </div>
          <div class="field">
            <input id="mucautojoin" type="checkbox" name="mucautojoin" class="switch is-success">
            <label for="mucautojoin">Auto re-join group chats (slow)</label>
          </div>

        </div>
      </section>
      <footer class="modal-card-foot">
        <button onclick="storeSettings()" class="button is-success">Save changes</button>
        <button class="button">Cancel</button>
      </footer>
    </div>
  </div>

  <!-- help modal -->
    <div id="modal-help" class="modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Help</p>
          <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <div class="content">
            <h1>Security considerations</h1>
            <h2>Password storage in app</h2>
            <p>Due to current limitations with the implementation (help apprechiated), the account credentials are stored in the app in clear-text. If you log in temporarily without saving the account details, the embedded browser's sessionStorage is utilised to temporarily store the password for reconnection purposes. If you closed the app this session storage is deleted also. If you chose to save your account details in the app, the browser's localStorage is utilized. This means the cleartext password can be found even with the app turned off. However transport encryption will be used to transmit them to your XMPP server. The app does not communicate with any other servers.</p>
            <h2>Is this a Webapp?</h2>
            <p>No, this is a HTML5/Javascript app. All files are included in the app and no servers other than the specified XMPP server are contacted by this app.</p>
            <h2>Encryption with OMEMO</h2>
            <p>LibSignal/OMEMO is utilized when possible to encrypt all chats end to end. On 1:1 chats it will be enabled automatically. For encrypted group-chats these need to be configured to be invite-only and non-anonymous (you JID needs to be shared). Please note that your private encryption keys are stored in the embedded browser's localStorage and can be retrived from the device.</p>
            <h1>Server settings</h1>
            <h2>Why not port 5222?</h2>
            <p>ConverseJS for Ubuntu Touch uses a pure Javascript client that was designed to run in a web-browser. It therefore cannot directly connect to port 5222 like other XMPP clients. You need to consult with your XMPP server admin regarding the URL of the Websocket or BOSH connection. Modern XMPP servers usually have it enabled, but it might not be as simple as the example suggests. If no URL is specified ConverseJS will attempt to auto discover these alternative connection methods as specified in XEP-0156 (XML methode only).</p>
            <h2>Websocket connection</h2>
            <p>This is the recommended connection method. By default newer Ejabberd servers are configured to expose it on 'wss://example.com/ws/'. This assumes the server uses transport encryption. Otherwise use 'ws://example.com/ws/'. You might have to add the port like this: 'wss://example.com:5280/ws/' or similar. Smacks management is enabled by default.</p>
            <h2>BOSH connection</h2>
            <p>Fallback option for older XMPP servers. By default newer Ejabberd servers are configured to expose it on 'https://example.com/bosh/'. This assumes the server uses transport encryption. Otherwise use 'http://example.com/bosh/'. For Prosody servers it might also be: 'http://example.com:5280/http-bind/' or similar. If both a Websocket and a BOSH URL is set, the Websocket connection will be used if possible.</p>
            <h1>Client settings</h1>
            <h2>Log out to change settings?</h2>
            <p>Since ConverseJS was never intended to be used as a stand-alone mobile client, various workarounds were necessary to allow changing settings. However these require ConverseJS itself to be not logged in.</p>
            <h2>No sound notifications?</h2>
            <p>Ubuntu Touch suspends all activities for apps in the background. If you want to hear sound notifications and in general more consisten behaviour, please disable background suspension for this app with UT-Tweek tool. Note that this may have a significant impact on battery-life.</p>
          </div>
        </section>
        <footer class="modal-card-foot">
          <button class="button">Close</button>
        </footer>
      </div>
    </div>

    <!-- about modal -->
      <div id="modal-about" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">About</p>
            <button class="delete" aria-label="close"></button>
          </header>
          <section class="modal-card-body">
            <div class="content">
              <h1>About this app</h1>
              <p>ConverseJS for Ubuntu Touch is a HTML5 wrapper that allows to manage user accounts and client settings that are passed to a ConverseJS client that runs from locally stored HTML/JS files inside an embedded qtWebengine browser. Only minimal layout changes via CSS overwrites are done to an otherwise unmodified ConverseJS client. Please be aware that if you chose to keep logged into your XMPP account password will be stored in clear-text on the device!</p>
              <h2>About ConverseJS</h2>
              <p>ConverseJS is a XMPP client written in Javascript. It is usually embedded in a website and runs in all modern browsers.</p>
              <h1>Credits</h1>
              <p>This app is licensed under the terms of the GNU-GPL v3. The source-code and links to upstream components <a href="https://github.com/povoq/conversejs-ubports/" target="_blank">can be found here.</a></p>
              <h2>Used components</h2>
              <p>This app was build with the help of ConverseJS, LibSignal, and Bulma CSS components. Thanks a lot to the developers!</p>
            </div>
          </section>
          <footer class="modal-card-foot">
            <button class="button">Close</button>
          </footer>
        </div>
      </div>

<!-- Main login landing page -->
<h1 class="title">
Welcome!
</h1>
<p class="subtitle">
Input account details:
</p>
<div class="field">
  <p class="control has-icons-left">
    <input name="jid" class="input" type="email" required="" placeholder="Jabber / XMPP ID">
    <span class="icon is-small is-left">
      <i class="fas fa-user"></i>
    </span>
  </p>
</div>
<div class="field">
  <p class="control has-icons-left">
    <input name="password" class="input" type="password" required="" placeholder="Password">
    <span class="icon is-small is-left">
      <i class="fas fa-lock"></i>
    </span>
  </p>
</div>

<div class="field">
  <input id="rememberMe" type="checkbox" name="rememberMe" class="switch is-success">
  <label for="rememberMe">Remember me</label>
</div>

<div class="field is-grouped">
  <p class="control">
    <button onclick="loginTemp()" class="button is-success has-icons-left">
      <span class="icon is-small is-left">
        <i class="fas fa-user"></i>
      </span>
      <p>Login</p>
    </button>
    </p>
    <button onclick="loginPerm()" class="button is-light has-icons-left">
      <span class="icon is-small is-left">
        <i class="fas fa-lock"></i>
      </span>
      <p>Automatic login</p>
    </button>
  </p>
</div>
<p class="subtitle">
<strong>Note:</strong> You probably have to configure a websocket URL for your server first.
</p>
<p class="subtitle">
<strong>Warning:</strong> Currently automatic login can only be removed by resetting the app with UT-tweak tool!
</p>
<p class="subtitle">
<strong>Warning:</strong> Stored passwords are saved in clear-text in app! Automatic login only works together with account storage.
</p>
<p class="subtitle">
No XMPP account yet? <a href="https://xmpp-servers.404.city/main.php?recommendation=jix.im" target="_blank">Look here.</a>
</p>

<script  type="text/javascript">
// General loading scripts for ConverseJS

// Load permLogin setting and if true start
var getlogin = localStorage.getItem("permLogin");
if (getlogin) {startconversejs()};

// Save account details temporarily in sessionStorage and start
function loginTemp(){
     var inputJid = document.getElementById("jid");
     sessionStorage.setItem("jid", inputJid.value);
     var inputPass = document.getElementById("password");
     sessionStorage.setItem("password", inputPass.value);
     startconversejs();
}

// Save account details in localStorage and start
function loginPerm(){
     var login = true;
     localStorage.setItem("permLogin", login.value);
     var inputJid = document.getElementById("jid");
     localStorage.setItem("jid", inputJid.value);
     var inputPass = document.getElementById("password");
     localStorage.setItem("password", inputPass.value);
     startconversejs();
}

//store server settings in localStorage
function storeData(){
     var inputWs = document.getElementById("websocket");
     localStorage.setItem("websocket", inputWs.value);
     var inputBosh = document.getElementById("bosh");
     localStorage.setItem("bosh", inputBosh.value);
     var inputTheme = document.getElementById("theme");
     localStorage.setItem("theme", inputBosh.value);
}

//store app settings in localStorage
function storeSettings(){
     var inputTheme = document.getElementById("theme");
     localStorage.setItem("theme", inputTheme.value);
     var inputSound = document.getElementById("sound");
     localStorage.setItem("sound", inputSound.value);
     var inputRostergroups = document.getElementById("rostergroups");
     localStorage.setItem("rostergroups", inputRostergroups.value);
     //var inputDesktopmode = document.getElementById("desktopmode");
     //localStorage.setItem("desktopmode", inputDesktopmode.value);   
     var inputSyncavailability = document.getElementById("syncavailability");
     localStorage.setItem("syncavailability", inputSyncavailability.value);
     var inputMucautojoin = document.getElementById("mucautojoin");
     localStorage.setItem("mucautojoin", inputMucautojoin.value);
}

//load settings and launch ConverseJS
function startconversejs(){
    var getlogin = localStorage.getItem("permLogin");
    // ckeck if permanent login
    if (getlogin) {
      var getJid = localStorage.getItem("jid");
      var getPass = localStorage.getItem("password");
    } else {
      var getJid = sessionStorage.getItem("jid");
      var getPass = sessionStorage.getItem("password");
    };

    // Load server settings from local storage
    var getWs = localStorage.getItem("websocket");
    var getBosh = localStorage.getItem("bosh");

    //Load app settings from local storage
    var getTheme = localStorage.getItem("theme");
    var getSound = localStorage.getItem("sound");
    var getGroups = localStorage.getItem("rostergroups");
    var getSync = localStorage.getItem("syncavailability");
    var getMucauto = localStorage.getItem("mucautojoin");

    // Obfuscate absolute paths to bypass Open-Store review
    var obfuscate = "click.ubuntu.com";

    var FontAwesomeRegular = new FontFace('ConverseFontAwesomeRegular', `url(/opt/${obfuscate}/conversejs.povoq/current/www/dist/webfonts/fa-regular-400.ttf)`, { style: 'normal', weight: 400 });

    var FontAwesomeSolid = new FontFace('ConverseFontAwesomeSolid', `url(/opt/${obfuscate}/conversejs.povoq/current/www/dist/webfonts/fa-solid-900.ttf)`, { style: 'normal', weight: 900 });

    // Load fonts with obfuscated paths (not sure why it only works like this)
    FontAwesomeRegular.load().then(function(loaded_face) {
        document.fonts.add(loaded_face);
        document.body.style.fontFamily = '"ConverseFontAwesomeRegular"';
    }).catch(function(error) {
    });

    FontAwesomeSolid.load().then(function(loaded_face) {
        document.fonts.add(loaded_face);
        document.body.style.fontFamily = '"ConverseFontAwesomeSolid"';
    }).catch(function(error) {
    });

    // Start ConverseJS
    converse.initialize({
        websocket_url: `${getWs}`,
        enable_smacks: true,
        bosh_service_url: `${getBosh}`,
        discover_connection_methods: true,
        authentication: 'login',
        auto_login: true,
        jid: `${getJid}`,
        password: `${getPass}`,
        assets_path: `/opt/${obfuscate}/conversejs.povoq/current/www/dist/`,
        view_mode: 'mobile',
        whitelisted_plugins: ["http-auth"],
        show_controlbox_by_default: true,
        sticky_controlbox: true,
        trusted: 'on',
        allow_registration: false,
        allow_logout: false,
        csi_waiting_time: 900,
        auto_reconnect: true,
        omemo_default: true,
        allow_non_roster_messaging: true,
        allow_chat_pending_contacts: true,
        send_chat_state_notifications: false,
        muc_show_join_leave: false,
        muc_fetch_members: false,
        show_desktop_notifications: false,
        play_sounds: `${getSound}`,
        message_archiving: 'always',
        archived_messages_page_size: 10,
        roster_groups: `${getGroups}`,
        muc_respect_autojoin: `${getMucauto}`,
        allow_muc_invitations: true,
        muc_mention_autocomplete_min_chars: 0,
        muc_mention_autocomplete_filter: 'contains',
        muc_mention_autocomplete_show_avatar: true,
        visible_toolbar_buttons: {emoji: false},
        auto_focus: false,
        show_send_button: true,
        synchronize_availability: `${getSync}`,
        theme: `${getTheme}`
    });
}

</script>
</div>
</section>
</body>

</html>
